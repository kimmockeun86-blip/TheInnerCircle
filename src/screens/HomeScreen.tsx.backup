import React, { useState, useEffect, useRef } from 'react';
import { View, Text, StyleSheet, TouchableOpacity, Modal, TextInput, ScrollView, SafeAreaView, Alert, Animated, useWindowDimensions, Image, ActivityIndicator, Platform } from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import MysticVisualizer from '../components/MysticVisualizer';
import { HomeScreenNavigationProp, HomeScreenRouteProp } from '../types/navigation';
import { api } from '../services/api';
import * as ImagePicker from 'expo-image-picker';

interface HomeScreenProps {
  route: HomeScreenRouteProp;
  navigation: HomeScreenNavigationProp;
}

interface JournalEntry {
  day: number;
  content: string;
  date: string;
  imageUri?: string;
}

const HomeScreen: React.FC<HomeScreenProps> = ({ route, navigation }) => {
  const { width: SCREEN_WIDTH } = useWindowDimensions();

  const [name, setName] = useState(route.params?.name || 'êµ¬ë„ì');
  const [deficit, setDeficit] = useState(route.params?.deficit || 'ì„±ì¥');

  const [dayCount, setDayCount] = useState(1);
  const [savedJournal, setSavedJournal] = useState('');
  const [journalModalVisible, setJournalModalVisible] = useState(false);
  const [journalInput, setJournalInput] = useState('');
  const [selectedImage, setSelectedImage] = useState<string | null>(null);
  const [historyModalVisible, setHistoryModalVisible] = useState(false);
  const [introModalVisible, setIntroModalVisible] = useState(false);
  const [analysisModalVisible, setAnalysisModalVisible] = useState(false);

  const [currentAnalysis, setCurrentAnalysis] = useState<{ result: string; feedback: string } | null>(null);

  const [journalHistory, setJournalHistory] = useState<JournalEntry[]>([]);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [missionStatus, setMissionStatus] = useState<string | null>(null);
  const [aiAnalysis, setAiAnalysis] = useState<string | null>(null);
  const [userGender, setUserGender] = useState<string>('ì•Œ ìˆ˜ ì—†ìŒ');
  const [userPhoto, setUserPhoto] = useState<string | null>(null);
  const [currentMissionText, setCurrentMissionText] = useState<string>('');
  const [nextMissionUnlockTime, setNextMissionUnlockTime] = useState<string | null>(null);

  const sparkleAnim1 = useRef(new Animated.Value(0)).current;
  const sparkleAnim2 = useRef(new Animated.Value(0)).current;
  const sparkleAnim3 = useRef(new Animated.Value(0)).current;

  const visualizerMode = isAnalyzing ? 'thinking' : (dayCount === 10 ? 'speaking' : 'listening');

  const missions = [
    "ì˜¤ëŠ˜ í•˜ë£¨ ë‹¹ì‹ ì´ ëŠë‚€ ê°€ì¥ ê°•ë ¬í•œ ê°ì •ì„ ê¸°ë¡í•˜ì‹­ì‹œì˜¤.",
    "ë‹¹ì‹ ì´ ê°€ì¥ íšŒí”¼í•˜ê³  ì‹¶ì€ ì§ˆë¬¸ì„ ìŠ¤ìŠ¤ë¡œì—ê²Œ ë˜ì§€ì‹­ì‹œì˜¤.",
    "ì˜¤ëŠ˜ ë§Œë‚œ ì‚¬ëŒ ì¤‘ í•œ ëª…ì˜ ëˆˆë¹›ì„ ê¸°ì–µí•˜ê³  ê·¸ ì˜ë¯¸ë¥¼ ì„±ì°°í•˜ì‹­ì‹œì˜¤.",
    "ë‹¹ì‹ ì˜ ê²°í•ì´ ì¤€ ê°€ì¥ í° ì„ ë¬¼ì´ ë¬´ì—‡ì¸ì§€ ê¸°ë¡í•˜ì‹­ì‹œì˜¤.",
    "ì˜¤ëŠ˜ í•˜ë£¨ ì¤‘ ê°€ì¥ ê³ ìš”í–ˆë˜ ìˆœê°„ì„ í¬ì°©í•˜ì—¬ ê·¸ ê°ê°ì„ ê¸°ë¡í•˜ì‹­ì‹œì˜¤.",
    "ë‹¹ì‹ ì´ ê°€ì¥ ì‚¬ë‘í•˜ëŠ” ì‚¬ëŒì—ê²Œ ì „í•˜ì§€ ëª»í•œ ë§ì„ ì ìœ¼ì‹­ì‹œì˜¤.",
    "ì˜¤ëŠ˜ì˜ ì‹¤íŒ¨ë¥¼ í•˜ë‚˜ ì„ íƒí•˜ê³  ê·¸ê²ƒì´ ê°€ë¥´ì³ì¤€ êµí›ˆì„ ê¸°ë¡í•˜ì‹­ì‹œì˜¤.",
    "ë‹¹ì‹ ì˜ ë‚´ë©´ì—ì„œ ê°€ì¥ í° ì†Œë¦¬ë¥¼ ë‚´ëŠ” ë‘ë ¤ì›€ì„ ì§ë©´í•˜ì‹­ì‹œì˜¤.",
    "ì˜¤ëŠ˜ ë‹¹ì‹ ì´ ëˆ„êµ°ê°€ì—ê²Œ ë² í‘¼ ì‚¬ì†Œí•œ ì¹œì ˆì„ ê¸°ì–µí•˜ì‹­ì‹œì˜¤.",
  ];

  const sparkles = [
    { anim: sparkleAnim1, style: { top: '20%', left: '15%' } },
    { anim: sparkleAnim2, style: { top: '25%', right: '20%' } },
    { anim: sparkleAnim3, style: { top: '35%', left: '25%' } },
  ];

  const loadJournalHistory = async () => {
    try {
      const allJournals = await AsyncStorage.getItem('journalHistory');
      if (allJournals) {
        setJournalHistory(JSON.parse(allJournals));
      }
    } catch (e) {
      console.error('ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
    }
  };

  const checkDayProgression = async () => {
    const lastCompletedDate = await AsyncStorage.getItem('lastCompletedDate');
    if (!lastCompletedDate) return true;

    const lastDate = new Date(lastCompletedDate);
    const now = new Date();

    const nextDay9AM = new Date(lastDate);
    nextDay9AM.setDate(lastDate.getDate() + 1);
    nextDay9AM.setHours(9, 0, 0, 0);

    if (now < nextDay9AM) {
      setNextMissionUnlockTime(nextDay9AM.toLocaleString());
      return false;
    }
    return true;
  };

  useEffect(() => {
    const initializeData = async () => {
      try {
        const isCoupled = await AsyncStorage.getItem('isCoupled');
        if (isCoupled === 'coupled') {
          navigation.replace('CouplesMission', {});
          return;
        }

        const storedDay = await AsyncStorage.getItem('dayCount');
        const currentDayCount = storedDay ? parseInt(storedDay, 10) : 1;
        setDayCount(currentDayCount);

        const storedJournal = await AsyncStorage.getItem('savedJournal');
        const storedMissionStatus = await AsyncStorage.getItem('missionStatus');
        const storedGender = await AsyncStorage.getItem('userGender');
        const storedPhoto = await AsyncStorage.getItem('userPhoto');
        const hasSeenIntro = await AsyncStorage.getItem('hasSeenIntro');

        const storedName = await AsyncStorage.getItem('userName');
        const storedDeficit = await AsyncStorage.getItem('userDeficit');

        if (storedJournal) setSavedJournal(storedJournal);
        if (storedMissionStatus) setMissionStatus(storedMissionStatus);
        if (storedGender) setUserGender(storedGender);
        if (storedPhoto) setUserPhoto(storedPhoto);

        if (!route.params?.name && storedName) setName(storedName);
        if (!route.params?.deficit && storedDeficit) setDeficit(storedDeficit);

        if (!hasSeenIntro) {
          setIntroModalVisible(true);
        }

        const storedMission = await AsyncStorage.getItem(`mission_day_${currentDayCount}`);
        if (storedMission) {
          setCurrentMissionText(storedMission);
        } else {
          const defaultMission = currentDayCount <= 9 ? missions[currentDayCount - 1] : "ë‹¹ì‹ ì˜ ì˜í˜¼ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.";
          setCurrentMissionText(defaultMission);
        }

        await loadJournalHistory();

        const genderForAnalysis = storedGender || 'ì•Œ ìˆ˜ ì—†ìŒ';
        const fullProfile = {
          name: name,
          gender: genderForAnalysis,
          age: await AsyncStorage.getItem('userAge') || 'ì•Œ ìˆ˜ ì—†ìŒ',
          location: await AsyncStorage.getItem('userLocation') || '',
          idealType: await AsyncStorage.getItem('userIdealType') || '',
          hobbies: await AsyncStorage.getItem('userHobbies') || '',
          job: await AsyncStorage.getItem('userJob') || '',
          growth: await AsyncStorage.getItem('userGrowth') || '',
          complex: await AsyncStorage.getItem('userComplex') || '',
          deficit: deficit
        };

        const analysisResult = await api.analyzeProfile(fullProfile);
        if (analysisResult.success) {
          setAiAnalysis(analysisResult.analysis);
          if (analysisResult.matchRecommendation) {
            await AsyncStorage.setItem('matchRecommendation', analysisResult.matchRecommendation);
          }
        }
      } catch (e) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    };
    initializeData();
  }, []);

  const pickImage = async () => {
    Alert.alert(
      "ì‚¬ì§„ ì¶”ê°€",
      "ì‚¬ì§„ì„ ê°€ì ¸ì˜¬ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”.",
      [
        {
          text: "ì¹´ë©”ë¼ë¡œ ì´¬ì˜",
          onPress: async () => {
            const { status } = await ImagePicker.requestCameraPermissionsAsync();
            if (status !== 'granted') {
              Alert.alert('ê¶Œí•œ í•„ìš”', 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
              return;
            }
            const result = await ImagePicker.launchCameraAsync({
              mediaTypes: ImagePicker.MediaTypeOptions.Images,
              allowsEditing: false,
              aspect: [4, 3],
              quality: 0.8,
            });
            if (!result.canceled) {
              setSelectedImage(result.assets[0].uri);
            }
          }
        },
        {
          text: "ì•¨ë²”ì—ì„œ ì„ íƒ",
          onPress: async () => {
            const result = await ImagePicker.launchImageLibraryAsync({
              mediaTypes: ImagePicker.MediaTypeOptions.Images,
              allowsEditing: false,
              aspect: [4, 3],
              quality: 0.8,
            });
            if (!result.canceled) {
              setSelectedImage(result.assets[0].uri);
            }
          }
        },
        { text: "ì·¨ì†Œ", style: "cancel" }
      ]
    );
  };

  const handleCompleteReflection = async () => {
    if (journalInput.trim().length < 1) {
      Alert.alert('ì•Œë¦¼', 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const canProceed = await checkDayProgression();
    if (!canProceed && nextMissionUnlockTime) {
      Alert.alert('ì•Œë¦¼', `ë‹¤ìŒ ë¯¸ì…˜ì€ ${nextMissionUnlockTime}ì— ì—´ë¦½ë‹ˆë‹¤.`);
      return;
    }

    setIsAnalyzing(true);

    try {
      const formData = new FormData();
      formData.append('journalText', journalInput);
      formData.append('name', name);
      formData.append('deficit', deficit);
      formData.append('dayCount', dayCount.toString());

      if (selectedImage) {
        const filename = selectedImage.split('/').pop();
        const match = /(\.\w+)$/.exec(filename || '');
        const type = match ? `image/${match[1]}` : `image`;
        formData.append('image', { uri: selectedImage, name: filename, type } as any);
      }

      const timeoutPromise = new Promise((_, reject) =>
        setTimeout(() => reject(new Error('TIMEOUT')), 15000)
      );

      const response: any = await Promise.race([
        api.analyzeJournal(formData),
        timeoutPromise
      ]);

      if (response.success) {
        setCurrentAnalysis({ result: response.result, feedback: response.feedback });

        const newEntry: JournalEntry = {
          day: dayCount,
          content: journalInput,
          date: new Date().toLocaleDateString(),
          imageUri: selectedImage || undefined
        };

        const updatedHistory = [newEntry, ...journalHistory];
        setJournalHistory(updatedHistory);
        await AsyncStorage.setItem('journalHistory', JSON.stringify(updatedHistory));

        const newDay = dayCount + 1;
        setDayCount(newDay);
        setMissionStatus(null);
        await AsyncStorage.setItem('dayCount', newDay.toString());
        await AsyncStorage.removeItem('missionStatus');
        await AsyncStorage.setItem('lastCompletedDate', new Date().toISOString());

        if (response.recommendedMission) {
          await AsyncStorage.setItem(`mission_day_${newDay}`, response.recommendedMission);
        }

        setJournalModalVisible(false);
        setJournalInput('');
        setSelectedImage(null);

        const fullProfile = {
          name: name,
          deficit: deficit,
          recentJournal: journalInput,
          previousAnalysis: aiAnalysis
        };
        api.analyzeProfile(fullProfile).then(reAnalysis => {
          if (reAnalysis.success) {
            setAiAnalysis(reAnalysis.analysis);
          }
        });

        setAnalysisModalVisible(true);

      } else {
        Alert.alert('ì˜¤ë¥˜', 'ë¶„ì„ ì‹¤íŒ¨: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    } catch (e: any) {
      console.error('Analysis Error:', e);
      if (e.message === 'TIMEOUT') {
        Alert.alert('ì˜¤ë¥˜', 'ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. (15ì´ˆ)');
      } else {
        Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + (e.message || ''));
      }
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleDay10Navigation = () => {
    if (userGender === 'ë‚¨ì„±') {
      Alert.alert('ì‹¬íŒì˜ ì‹œê°„', 'ë‹¹ì‹ ì˜ ìê²©ì„ ì¦ëª…í•˜ê¸° ìœ„í•´ ë§ˆì§€ë§‰ ê¸°ë¡ì„ ë‚¨ê¸°ì‹­ì‹œì˜¤.', [
        { text: 'í™•ì¸', onPress: () => setJournalModalVisible(true) }
      ]);
    } else {
      Alert.alert('ë§¤ì¹­ ì‹œì‘', 'ìš´ëª…ì˜ ìƒëŒ€ë¥¼ ì°¾ê¸° ìœ„í•œ ì—¬ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.', [
        {
          text: 'í™•ì¸', onPress: () => {
            Alert.alert('ì•Œë¦¼', 'ë§¤ì¹­ ì‹œìŠ¤í…œì´ ê³§ í™œì„±í™”ë©ë‹ˆë‹¤.');
          }
        }
      ]);
    }
  };

  useEffect(() => {
    if (dayCount === 10) {
      Animated.loop(
        Animated.sequence([
          Animated.timing(sparkleAnim1, { toValue: 1, duration: 1000, useNativeDriver: true }),
          Animated.timing(sparkleAnim1, { toValue: 0, duration: 1000, useNativeDriver: true }),
        ])
      ).start();

      Animated.loop(
        Animated.sequence([
          Animated.delay(300),
          Animated.timing(sparkleAnim2, { toValue: 1, duration: 1000, useNativeDriver: true }),
          Animated.timing(sparkleAnim2, { toValue: 0, duration: 1000, useNativeDriver: true }),
        ])
      ).start();

      Animated.loop(
        Animated.sequence([
          Animated.delay(600),
          Animated.timing(sparkleAnim3, { toValue: 1, duration: 1000, useNativeDriver: true }),
          Animated.timing(sparkleAnim3, { toValue: 0, duration: 1000, useNativeDriver: true }),
        ])
      ).start();
    }
  }, [dayCount]);

  return (
    <View style={styles.container}>
      <View style={styles.visualizerBackground}>
        <MysticVisualizer isActive={true} mode={visualizerMode} />
      </View>

      <SafeAreaView style={styles.safeArea}>
        <View style={styles.header}>
          <Text style={styles.headerTitle}>THE INNER CIRCLE</Text>
          <TouchableOpacity style={styles.settingsButton} onPress={() => navigation.navigate('Settings', {})}>
            <Text style={styles.settingsIcon}>âš™ï¸</Text>
          </TouchableOpacity>
        </View>

        <ScrollView contentContainerStyle={styles.scrollContent} showsVerticalScrollIndicator={false}>

          <View style={styles.visualizerSpacer} />

          <View style={styles.infoContainer}>
            {userPhoto && (
              <View style={styles.photoContainer}>
                <Image source={{ uri: userPhoto }} style={styles.userPhoto} />
              </View>
            )}
            <Text style={styles.nameText}>{name}</Text>
            <Text style={styles.dayText}>Day {dayCount}</Text>
            <View style={styles.divider} />
            <Text style={styles.deficitText}>ë‹¹ì‹ ì˜ ê²°í•: {deficit}</Text>

            {aiAnalysis && (
              <View style={styles.analysisContainer}>
                <Text style={styles.analysisTitle}>ğŸ§  AI ì˜í˜¼ ë¶„ì„</Text>
                <Text style={styles.analysisText}>{aiAnalysis}</Text>
              </View>
            )}
          </View>

          <View style={styles.missionContainer}>
            {dayCount === 10 ? (
              missionStatus === 'accepted' ? (
                <>
                  <Text style={styles.specialMissionTitle}>ğŸ¤« ë¹„ë°€ ì§€ë ¹ ìˆ˜í–‰</Text>
                  <Text style={styles.specialMissionText}>
                    ìƒëŒ€ë°©ê³¼ì˜ ì•½ì†ëœ ì‹œê°„ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.{'\n'}
                    ì´ì œ ì§€ë ¹ì„ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                  </Text>
                  <TouchableOpacity
                    style={[styles.matchButton, { backgroundColor: '#FF4500', borderColor: '#FF4500' }]}
                    onPress={() => setJournalModalVisible(true)}
                    disabled={isAnalyzing}
                  >
                    <Text style={styles.matchButtonText}>{isAnalyzing ? "AI ì •ë°€ ë¶„ì„ ì¤‘..." : "ğŸ”¥ ì§€ë ¹ ìˆ˜í–‰ ë° ë¶„ì„"}</Text>
                  </TouchableOpacity>
                </>
              ) : (
                <>
                  <Text style={styles.specialMissionTitle}>
                    {userGender === 'ë‚¨ì„±' ? 'âš–ï¸ ìš´ëª…ì˜ ì‹¬íŒ' : 'ğŸŒŸ ì˜í˜¼ì˜ ë§¤ì¹­'}
                  </Text>
                  <Text style={styles.specialMissionText}>
                    {userGender === 'ë‚¨ì„±'
                      ? 'ë‹¹ì‹ ì˜ ì—¬ì •ì„ í‰ê°€í•  ì‹œê°„ì…ë‹ˆë‹¤.\nì§„ì •í•œ ìê²©ì„ ê°–ì¶”ì—ˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.'
                      : 'ë‹¹ì‹ ì˜ ë‚´ë©´ì€ ì¶©ë¶„íˆ ì„±ìˆ™í–ˆìŠµë‹ˆë‹¤.\nì´ì œ ê°™ì€ ì—¬ì •ì„ ê±·ëŠ” ì˜í˜¼ê³¼ì˜\në§Œë‚¨ì„ ì‹œì‘í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.'}
                  </Text>
                  <TouchableOpacity
                    style={[styles.matchButton, userGender === 'ë‚¨ì„±' && { backgroundColor: '#333', borderColor: '#555' }]}
                    onPress={handleDay10Navigation}
                  >
                    <Text style={styles.matchButtonText}>
                      {userGender === 'ë‚¨ì„±' ? 'âš–ï¸ ìµœì¢… ì‹¬íŒ ë°›ê¸°' : 'âœ¨ ë§¤ì¹­ ì‹œì‘í•˜ê¸°'}
                    </Text>
                  </TouchableOpacity>
                </>
              )
            ) : (
              <>
                <Text style={styles.missionTitle}>ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</Text>
                <View style={styles.missionBox}>
                  <Text style={styles.missionText}>{currentMissionText}</Text>
                </View>
                <TouchableOpacity style={styles.reflectButton} onPress={() => setJournalModalVisible(true)}>
                  <Text style={styles.reflectButtonText}>âœï¸ ìˆ˜í–‰ ê¸°ë¡ ë‚¨ê¸°ê¸°</Text>
                </TouchableOpacity>
              </>
            )}

            <TouchableOpacity style={styles.viewJournalButton} onPress={() => setHistoryModalVisible(true)}>
              <Text style={styles.viewJournalButtonText}>ğŸ“œ ì§€ë‚œ ì—¬ì • ë³´ê¸°</Text>
            </TouchableOpacity>

            <TouchableOpacity style={styles.devButton} onPress={async () => {
              const newDay = 10;
              setDayCount(newDay);
              setMissionStatus('accepted');
              await AsyncStorage.setItem('dayCount', newDay.toString());
              await AsyncStorage.setItem('missionStatus', 'accepted');
              Alert.alert('ê°œë°œì ëª¨ë“œ', 'Day 10ìœ¼ë¡œ ì´ë™ ë° ë¯¸ì…˜ ì„±ê³µ ì²˜ë¦¬ ì™„ë£Œ.');
            }}>
              <Text style={styles.devButtonText}>[ê°œë°œìš©] Day 10ìœ¼ë¡œ ì´ë™</Text>
            </TouchableOpacity>
          </View>
        </ScrollView>
      </SafeAreaView>

      <Modal visible={journalModalVisible} animationType="slide" transparent={true}>
        <View style={styles.modalOverlay}>
          <View style={[styles.modalContent, styles.modalWrapper]}>
            <ScrollView contentContainerStyle={styles.modalScrollContent}>
              <Text style={styles.modalTitle}>ì˜¤ëŠ˜ì˜ ê¸°ë¡</Text>
              <Text style={styles.modalSubtitle}>ë‹¹ì‹ ì˜ ë‚´ë©´ì„ ì†”ì§í•˜ê²Œ í„¸ì–´ë†“ìœ¼ì„¸ìš”.</Text>

              <TouchableOpacity style={styles.imagePickerButton} onPress={pickImage}>
                {selectedImage ? (
                  <Image source={{ uri: selectedImage }} style={styles.previewImage} resizeMode="cover" />
                ) : (
                  <Text style={styles.imagePickerText}>ğŸ“· ì‚¬ì§„ ì¶”ê°€í•˜ê¸°</Text>
                )}
              </TouchableOpacity>

              <TextInput
                style={styles.journalInput}
                placeholder="ì—¬ê¸°ì— ì‘ì„±í•˜ì„¸ìš”..."
                placeholderTextColor="#666"
                multiline
                value={journalInput}
                onChangeText={setJournalInput}
              />
              {isAnalyzing ? (
                <ActivityIndicator size="large" color="#FFD700" style={{ marginBottom: 20 }} />
              ) : (
                <TouchableOpacity style={styles.saveButton} onPress={handleCompleteReflection}>
                  <Text style={styles.saveButtonText}>ì œì¶œ ë° ë¶„ì„</Text>
                </TouchableOpacity>
              )}
              <TouchableOpacity style={styles.cancelButton} onPress={() => setJournalModalVisible(false)}>
                <Text style={styles.cancelButtonText}>ì·¨ì†Œ</Text>
              </TouchableOpacity>
            </ScrollView>
          </View>
        </View>
      </Modal>

      <Modal visible={analysisModalVisible} transparent={true} animationType="fade">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <View style={{ marginTop: 10 }}>
              <Text style={[styles.introText, { fontSize: 16, lineHeight: 26, textAlign: 'center', color: '#FFD700' }]}>{currentAnalysis?.feedback}</Text>
            </View>
            <TouchableOpacity style={styles.saveButton} onPress={() => setAnalysisModalVisible(false)}>
              <Text style={styles.saveButtonText}>í™•ì¸</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      <Modal visible={historyModalVisible} animationType="fade" transparent={true}>
        <View style={styles.modalOverlay}>
          <View style={styles.historyModalContent}>
            <Text style={styles.modalTitle}>ì§€ë‚œ ì—¬ì •ì˜ ê¸°ë¡</Text>
            <ScrollView style={styles.historyScroll}>
              {journalHistory.length === 0 ? (
                <Text style={styles.emptyHistoryText}>ì•„ì§ ê¸°ë¡ëœ ì—¬ì •ì´ ì—†ìŠµë‹ˆë‹¤.</Text>
              ) : (
                journalHistory.map((entry, index) => (
                  <View key={index} style={styles.historyEntry}>
                    <Text style={styles.historyDay}>Day {entry.day}</Text>
                    {entry.imageUri && (
                      <Image source={{ uri: entry.imageUri }} style={styles.historyImage} resizeMode="cover" />
                    )}
                    <Text style={styles.historyContent}>{entry.content}</Text>
                    <Text style={styles.historyDate}>{entry.date}</Text>
                  </View>
                ))
              )}
            </ScrollView>
            <TouchableOpacity style={styles.closeButton} onPress={() => setHistoryModalVisible(false)}>
              <Text style={styles.closeButtonText}>ë‹«ê¸°</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      <Modal visible={introModalVisible} transparent={true} animationType="fade">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>í™˜ì˜í•©ë‹ˆë‹¤</Text>
            <Text style={styles.introText}>
              ë‹¹ì‹ ì€ ì´ì œ ë‚´ë©´ì˜ ì„±ì¥ì„ ìœ„í•œ 10ì¼ê°„ì˜ ì—¬ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.{'\n\n'}
              ë§¤ì¼ ì£¼ì–´ì§€ëŠ” ë¯¸ì…˜ì„ ìˆ˜í–‰í•˜ê³ , ë‹¹ì‹ ì˜ ì˜í˜¼ì„ ê¸°ë¡í•˜ì„¸ìš”.{'\n\n'}
              ì§„ì •í•œ ìì‹ ì„ ë§ˆì£¼í•  ë•Œ, ìš´ëª…ì˜ ìƒëŒ€ë¥¼ ë§Œë‚  ìê²©ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.
            </Text>
            <TouchableOpacity style={styles.saveButton} onPress={async () => {
              await AsyncStorage.setItem('hasSeenIntro', 'true');
              setIntroModalVisible(false);
            }}>
              <Text style={styles.saveButtonText}>ì—¬ì • ì‹œì‘í•˜ê¸°</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>
    </View>
  );
};

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#050510' },
  visualizerBackground: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
          < View style={ styles.visualizerSpacer } />

          <View style={styles.infoContainer}>
            {userPhoto && (
              <View style={styles.photoContainer}>
                <Image source={{ uri: userPhoto }} style={styles.userPhoto} />
              </View>
            )}
            <Text style={styles.nameText}>{name}</Text>
            <Text style={styles.dayText}>Day {dayCount}</Text>
            <View style={styles.divider} />
            <Text style={styles.deficitText}>ë‹¹ì‹ ì˜ ê²°í•: {deficit}</Text>

            {aiAnalysis && (
              <View style={styles.analysisContainer}>
                <Text style={styles.analysisTitle}>ğŸ§  AI ì˜í˜¼ ë¶„ì„</Text>
                <Text style={styles.analysisText}>{aiAnalysis}</Text>
              </View>
            )}
          </View>

          <View style={styles.missionContainer}>
            {dayCount === 10 ? (
              missionStatus === 'accepted' ? (
                <>
                  <Text style={styles.specialMissionTitle}>ğŸ¤« ë¹„ë°€ ì§€ë ¹ ìˆ˜í–‰</Text>
                  <Text style={styles.specialMissionText}>
                    ìƒëŒ€ë°©ê³¼ì˜ ì•½ì†ëœ ì‹œê°„ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.{'\n'}
                    ì´ì œ ì§€ë ¹ì„ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                  </Text>
                  <TouchableOpacity
                    style={[styles.matchButton, { backgroundColor: '#FF4500', borderColor: '#FF4500' }]}
                    onPress={() => setJournalModalVisible(true)}
                    disabled={isAnalyzing}
                  >
                    <Text style={styles.matchButtonText}>{isAnalyzing ? "AI ì •ë°€ ë¶„ì„ ì¤‘..." : "ğŸ”¥ ì§€ë ¹ ìˆ˜í–‰ ë° ë¶„ì„"}</Text>
                  </TouchableOpacity>
                </>
              ) : (
                <>
                  <Text style={styles.specialMissionTitle}>
                    {userGender === 'ë‚¨ì„±' ? 'âš–ï¸ ìš´ëª…ì˜ ì‹¬íŒ' : 'ğŸŒŸ ì˜í˜¼ì˜ ë§¤ì¹­'}
                  </Text>
                  <Text style={styles.specialMissionText}>
                    {userGender === 'ë‚¨ì„±'
                      ? 'ë‹¹ì‹ ì˜ ì—¬ì •ì„ í‰ê°€í•  ì‹œê°„ì…ë‹ˆë‹¤.\nì§„ì •í•œ ìê²©ì„ ê°–ì¶”ì—ˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.'
                      : 'ë‹¹ì‹ ì˜ ë‚´ë©´ì€ ì¶©ë¶„íˆ ì„±ìˆ™í–ˆìŠµë‹ˆë‹¤.\nì´ì œ ê°™ì€ ì—¬ì •ì„ ê±·ëŠ” ì˜í˜¼ê³¼ì˜\në§Œë‚¨ì„ ì‹œì‘í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.'}
                  </Text>
                  <TouchableOpacity
                    style={[styles.matchButton, userGender === 'ë‚¨ì„±' && { backgroundColor: '#333', borderColor: '#555' }]}
                    onPress={handleDay10Navigation}
                  >
                    <Text style={styles.matchButtonText}>
                      {userGender === 'ë‚¨ì„±' ? 'âš–ï¸ ìµœì¢… ì‹¬íŒ ë°›ê¸°' : 'âœ¨ ë§¤ì¹­ ì‹œì‘í•˜ê¸°'}
                    </Text>
                  </TouchableOpacity>
                </>
              )
            ) : (
              <>
                <Text style={styles.missionTitle}>ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</Text>
                <View style={styles.missionBox}>
                  <Text style={styles.missionText}>{currentMissionText}</Text>
                </View>
                <TouchableOpacity style={styles.reflectButton} onPress={() => setJournalModalVisible(true)}>
                  <Text style={styles.reflectButtonText}>âœï¸ ìˆ˜í–‰ ê¸°ë¡ ë‚¨ê¸°ê¸°</Text>
                </TouchableOpacity>
              </>
            )}

            <TouchableOpacity style={styles.viewJournalButton} onPress={() => setHistoryModalVisible(true)}>
              <Text style={styles.viewJournalButtonText}>ğŸ“œ ì§€ë‚œ ì—¬ì • ë³´ê¸°</Text>
            </TouchableOpacity>

            <TouchableOpacity style={styles.devButton} onPress={async () => {
              const newDay = 10;
              setDayCount(newDay);
              setMissionStatus('accepted');
              await AsyncStorage.setItem('dayCount', newDay.toString());
              await AsyncStorage.setItem('missionStatus', 'accepted');
              Alert.alert('ê°œë°œì ëª¨ë“œ', 'Day 10ìœ¼ë¡œ ì´ë™ ë° ë¯¸ì…˜ ì„±ê³µ ì²˜ë¦¬ ì™„ë£Œ.');
            }}>
              <Text style={styles.devButtonText}>[ê°œë°œìš©] Day 10ìœ¼ë¡œ ì´ë™</Text>
            </TouchableOpacity>
          </View>
        </ScrollView >
      </SafeAreaView >

      <Modal visible={journalModalVisible} animationType="slide" transparent={true}>
        <View style={styles.modalOverlay}>
          <View style={[styles.modalContent, styles.modalWrapper]}>
            <ScrollView contentContainerStyle={styles.modalScrollContent}>
              <Text style={styles.modalTitle}>ì˜¤ëŠ˜ì˜ ê¸°ë¡</Text>
              <Text style={styles.modalSubtitle}>ë‹¹ì‹ ì˜ ë‚´ë©´ì„ ì†”ì§í•˜ê²Œ í„¸ì–´ë†“ìœ¼ì„¸ìš”.</Text>

              <TouchableOpacity style={styles.imagePickerButton} onPress={pickImage}>
                {selectedImage ? (
                  <Image source={{ uri: selectedImage }} style={styles.previewImage} resizeMode="cover" />
                ) : (
                  <Text style={styles.imagePickerText}>ğŸ“· ì‚¬ì§„ ì¶”ê°€í•˜ê¸°</Text>
                )}
              </TouchableOpacity>

              <TextInput
                style={styles.journalInput}
                placeholder="ì—¬ê¸°ì— ì‘ì„±í•˜ì„¸ìš”..."
                placeholderTextColor="#666"
                multiline
                value={journalInput}
                onChangeText={setJournalInput}
              />
              {isAnalyzing ? (
                <ActivityIndicator size="large" color="#FFD700" style={{ marginBottom: 20 }} />
              ) : (
                <TouchableOpacity style={styles.saveButton} onPress={handleCompleteReflection}>
                  <Text style={styles.saveButtonText}>ì œì¶œ ë° ë¶„ì„</Text>
                </TouchableOpacity>
              )}
              <TouchableOpacity style={styles.cancelButton} onPress={() => setJournalModalVisible(false)}>
                <Text style={styles.cancelButtonText}>ì·¨ì†Œ</Text>
              </TouchableOpacity>
            </ScrollView>
          </View>
        </View>
      </Modal>

      <Modal visible={analysisModalVisible} transparent={true} animationType="fade">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <View style={{ marginTop: 10 }}>
              <Text style={[styles.introText, { fontSize: 16, lineHeight: 26, textAlign: 'center', color: '#FFD700' }]}>{currentAnalysis?.feedback}</Text>
            </View>
            <TouchableOpacity style={styles.saveButton} onPress={() => setAnalysisModalVisible(false)}>
              <Text style={styles.saveButtonText}>í™•ì¸</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      <Modal visible={historyModalVisible} animationType="fade" transparent={true}>
        <View style={styles.modalOverlay}>
          <View style={styles.historyModalContent}>
            <Text style={styles.modalTitle}>ì§€ë‚œ ì—¬ì •ì˜ ê¸°ë¡</Text>
            <ScrollView style={styles.historyScroll}>
              {journalHistory.length === 0 ? (
                <Text style={styles.emptyHistoryText}>ì•„ì§ ê¸°ë¡ëœ ì—¬ì •ì´ ì—†ìŠµë‹ˆë‹¤.</Text>
              ) : (
                journalHistory.map((entry, index) => (
                  <View key={index} style={styles.historyEntry}>
                    <Text style={styles.historyDay}>Day {entry.day}</Text>
                    {entry.imageUri && (
                      <Image source={{ uri: entry.imageUri }} style={styles.historyImage} resizeMode="cover" />
                    )}
                    <Text style={styles.historyContent}>{entry.content}</Text>
                    <Text style={styles.historyDate}>{entry.date}</Text>
                  </View>
                ))
              )}
            </ScrollView>
            <TouchableOpacity style={styles.closeButton} onPress={() => setHistoryModalVisible(false)}>
              <Text style={styles.closeButtonText}>ë‹«ê¸°</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      <Modal visible={introModalVisible} transparent={true} animationType="fade">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>í™˜ì˜í•©ë‹ˆë‹¤</Text>
            <Text style={styles.introText}>
              ë‹¹ì‹ ì€ ì´ì œ ë‚´ë©´ì˜ ì„±ì¥ì„ ìœ„í•œ 10ì¼ê°„ì˜ ì—¬ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.{'\n\n'}
              ë§¤ì¼ ì£¼ì–´ì§€ëŠ” ë¯¸ì…˜ì„ ìˆ˜í–‰í•˜ê³ , ë‹¹ì‹ ì˜ ì˜í˜¼ì„ ê¸°ë¡í•˜ì„¸ìš”.{'\n\n'}
              ì§„ì •í•œ ìì‹ ì„ ë§ˆì£¼í•  ë•Œ, ìš´ëª…ì˜ ìƒëŒ€ë¥¼ ë§Œë‚  ìê²©ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.
            </Text>
            <TouchableOpacity style={styles.saveButton} onPress={async () => {
              await AsyncStorage.setItem('hasSeenIntro', 'true');
              setIntroModalVisible(false);
            }}>
              <Text style={styles.saveButtonText}>ì—¬ì • ì‹œì‘í•˜ê¸°</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>
    </View >
  );
};

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#050510' },
  visualizerBackground: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    zIndex: 0,
  },
  safeArea: { flex: 1, paddingTop: Platform.OS === 'android' ? 40 : 0, zIndex: 10 },
  header: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', paddingHorizontal: 20, paddingVertical: 15 },
  headerTitle: { color: '#FFD700', fontSize: 18, fontWeight: '700', letterSpacing: 4 },
  settingsButton: { padding: 10 },
  settingsIcon: { fontSize: 22, color: '#FFD700' },

  scrollContent: { flexGrow: 1, paddingBottom: 100 },
  visualizerSpacer: { height: 280 },

  infoContainer: { alignItems: 'center', marginBottom: 35, paddingHorizontal: 25, width: '100%' },
  photoContainer: { width: 100, height: 100, borderRadius: 50, overflow: 'hidden', marginBottom: 18, borderWidth: 3, borderColor: '#FFD700', shadowColor: '#FFD700', shadowOpacity: 0.7, shadowRadius: 20, elevation: 12 },
  userPhoto: { width: '100%', height: '100%' },
  nameText: { color: '#FFF', fontSize: 32, fontWeight: '700', marginBottom: 6, textShadowColor: 'rgba(255, 215, 0, 0.6)', textShadowOffset: { width: 0, height: 0 }, textShadowRadius: 25 },
  dayText: { color: '#FFD700', fontSize: 56, fontWeight: '200', marginBottom: 12, letterSpacing: 6 },
  divider: { width: 50, height: 1, backgroundColor: '#FFD700', marginBottom: 18, opacity: 0.9 },
  deficitText: { color: '#C1C8E4', fontSize: 16, fontStyle: 'normal', textAlign: 'center', marginBottom: 22, fontWeight: '300' },

  analysisContainer: {
    marginTop: 18,
    padding: 22,
    backgroundColor: 'rgba(15, 15, 30, 0.9)',
    borderRadius: 18,
    borderWidth: 1,
    borderColor: 'rgba(255, 215, 0, 0.3)',
    width: '100%',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 5 },
    shadowOpacity: 0.5,
    shadowRadius: 10
  },
  analysisTitle: { color: '#FFD700', fontSize: 14, fontWeight: '600', marginBottom: 14, textAlign: 'center', letterSpacing: 3 },
  analysisText: { color: '#E8EAF6', fontSize: 14, lineHeight: 23, textAlign: 'center', fontWeight: '300' },

  missionContainer: { paddingHorizontal: 28, alignItems: 'center', marginBottom: 30, width: '100%' },
  missionTitle: { color: '#FFD700', fontSize: 20, fontWeight: '700', marginBottom: 22, letterSpacing: 3 },
  missionBox: {
    backgroundColor: 'rgba(255, 255, 255, 0.04)',
    padding: 28,
    borderRadius: 18,
    borderWidth: 1,
    borderColor: 'rgba(255, 215, 0, 0.25)',
    marginBottom: 35,
    width: '100%'
  },
  missionText: { color: '#F5F5F5', fontSize: 17, textAlign: 'center', lineHeight: 30, fontWeight: '300' },

  reflectButton: {
    backgroundColor: 'rgba(255, 215, 0, 0.12)',
    paddingVertical: 18,
    paddingHorizontal: 55,
    borderRadius: 35,
    borderWidth: 1.5,
    borderColor: '#FFD700',
    shadowColor: '#FFD700',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.6,
    shadowRadius: 15,
    elevation: 10,
    marginBottom: 20
  },
  reflectButtonText: { color: '#FFD700', fontSize: 16, fontWeight: '600', letterSpacing: 2.5 },

  specialMissionTitle: { color: '#FFD700', fontSize: 26, fontWeight: '700', textAlign: 'center', marginBottom: 22, textShadowColor: '#FFD700', textShadowOffset: { width: 0, height: 0 }, textShadowRadius: 25 },
  specialMissionText: { color: '#F5F5F5', fontSize: 16, textAlign: 'center', lineHeight: 27, marginBottom: 35, fontWeight: '300' },
  matchButton: {
    backgroundColor: '#FFD700',
    paddingVertical: 17,
    paddingHorizontal: 48,
    borderRadius: 35,
    shadowColor: '#FFD700',
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.75,
    shadowRadius: 22,
    elevation: 14,
    width: '100%',
    alignItems: 'center'
  },
  matchButtonText: { color: '#050510', fontSize: 18, fontWeight: '700', letterSpacing: 2.5 },

  viewJournalButton: { marginTop: 18, paddingVertical: 12 },
  viewJournalButtonText: { color: '#9CA3AF', fontSize: 13, textDecorationLine: 'underline', fontWeight: '400' },

  devButton: { marginTop: 50, padding: 12, backgroundColor: 'rgba(255, 69, 0, 0.08)', borderRadius: 10 },
  devButtonText: { color: '#FF4500', fontSize: 12 },

  modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.96)', justifyContent: 'center', alignItems: 'center' },
  modalContent: { width: '88%', backgroundColor: '#0D0D1A', borderRadius: 28, padding: 32, alignItems: 'center', borderWidth: 1, borderColor: '#2A2A40' },
  modalWrapper: { height: '82%' },
  modalScrollContent: { alignItems: 'center', paddingBottom: 25 },
  modalTitle: { color: '#FFD700', fontSize: 22, fontWeight: '700', marginBottom: 18 },
  modalSubtitle: { color: '#9CA3AF', fontSize: 13, marginBottom: 28, fontWeight: '300' },
  journalInput: { width: '100%', height: 210, backgroundColor: '#1A1A2E', borderRadius: 18, padding: 22, color: '#fff', fontSize: 15, textAlignVertical: 'top', marginBottom: 28, borderWidth: 1, borderColor: '#2A2A40', fontWeight: '300' },
  saveButton: { backgroundColor: '#FFD700', paddingVertical: 16, paddingHorizontal: 48, borderRadius: 30, marginBottom: 14, shadowColor: '#FFD700', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.4, shadowRadius: 10, elevation: 8 },
  saveButtonText: { color: '#050510', fontSize: 16, fontWeight: '700', letterSpacing: 1 },
  cancelButton: { padding: 14 },
  cancelButtonText: { color: '#6B7280', fontSize: 13, fontWeight: '400' },

  historyModalContent: { width: '90%', height: '85%', backgroundColor: '#0A0A15', borderRadius: 25, padding: 25, borderWidth: 1, borderColor: '#333' },
  historyScroll: { marginTop: 15 },
  historyEntry: { marginBottom: 30, borderBottomWidth: 1, borderBottomColor: '#222', paddingBottom: 25 },
  historyDay: { color: '#FFD700', fontSize: 20, fontWeight: 'bold', marginBottom: 12 },
  historyContent: { color: '#ddd', fontSize: 16, lineHeight: 24 },
  historyDate: { color: '#555', fontSize: 12, marginTop: 12, textAlign: 'right' },
  historyImage: { width: '100%', height: 220, borderRadius: 15, marginBottom: 20 },
  emptyHistoryText: { color: '#666', textAlign: 'center', marginTop: 120, fontSize: 16 },
  closeButton: { alignSelf: 'center', marginTop: 20, padding: 12 },
  closeButtonText: { color: '#fff', fontSize: 16 },

  introText: { color: '#E5E7EB', fontSize: 15, lineHeight: 25, textAlign: 'center', marginBottom: 32, fontWeight: '300' },

  imagePickerButton: { flexDirection: 'row', alignItems: 'center', backgroundColor: '#1A1A2E', borderRadius: 18, marginBottom: 24, width: '100%', justifyContent: 'center', height: 170, overflow: 'hidden', borderWidth: 1.5, borderColor: '#2A2A40', borderStyle: 'dashed' },
  imagePickerText: { color: '#9CA3AF', marginLeft: 10, fontSize: 14, fontWeight: '400' },
  previewImage: { width: '100%', height: '100%' },
});

export default HomeScreen;